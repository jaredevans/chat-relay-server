<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket Chat Relay Client</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: monospace; background: #181c24; color: #f2f2f2; margin: 0; }
    #chat { width: 100%; height: 60vh; background: #23283b; overflow-y: auto; padding: 1em; border-bottom: 1px solid #333;}
    #inputBar { display: flex; }
    #userInput { flex: 1; padding: 1em; background: #111; color: #f2f2f2; border: none;}
    #sendBtn { padding: 1em; background: #5d67ee; color: #fff; border: none; cursor: pointer;}
    #sendBtn:hover { background: #6e78ff; }
    #info { padding: .5em 1em; color: #82b1ff; font-size: 0.95em;}
    .me { color: #9fc6ff; }
  </style>
</head>
<body>
  <div id="chat" aria-live="polite"></div>
  <div id="info"></div>
  <div id="inputBar">
    <input id="userInput" type="text" placeholder="Type your message or commands here..." autocomplete="off" />
    <button id="sendBtn">Send</button>
  </div>
  <script>
    let ws;
    let quitting = false;
    let myCode = "";
    let myName = "";

    function log(msg, cls="") {
      const c = document.getElementById('chat');
      let el = document.createElement('div');
      if (cls) el.className = cls;
      el.textContent = msg;
      c.appendChild(el);
      c.scrollTop = c.scrollHeight;
    }
    function updateInfo() {
      document.getElementById('info').textContent =
        `Your chat code is ${myCode}, your name is "${myName}"`;
    }
    function info(msg) {
      document.getElementById('info').textContent = msg;
    }

    function connect() {
      ws = new WebSocket("wss://chat.jarednevans.com/ws/");
      ws.onopen = () => { info("Connected. Waiting for server..."); };
      ws.onmessage = (evt) => {
        const msg = evt.data;
        if (msg.startsWith("CONNECTED:")) {
          let parts = msg.split(":");
          myCode = parts[1];
          myName = parts[2];
          updateInfo();
          log("Welcome! Use /join CODE, /name NEWNAME, /chatroom, /list, /quit");
        }
        else if (msg.startsWith("PAIR:")) {
          let [,code,name] = msg.split(":",3);
          log(`[Connected! You are chatting with ${name} (code ${code})]`, "sys");
        }
        else if (msg.startsWith("MSGFROM:")) {
          let [,sender,text] = msg.split(":",3);
          log(`${sender}: ${text}`, "peer");
        }
        else if (msg.startsWith("RENAMED:")) {
          let newName = msg.split(":",2)[1];
          log(`[Your chat partner is now: ${newName}]`, "sys");
        }
        else if (msg === "PEER_LEFT") {
          log("[Your chat partner disconnected. Type /join CODE to connect to another.]", "sys");
        }
        else if (msg === "PEER_LEFT_CHATROOM") {
          log("[Your chat partner has left for the chatroom.]", "sys");
        }
        else if (msg.startsWith("CHATROOM:")) {
          let [,sender,text] = msg.split(":",3);
          log(`[${sender} @ chatroom]: ${text}`,"room");
        }
        else if (msg.startsWith("INFO:")) {
          log("[Info] " + msg.slice(5), "info");
          // The client now closes the websocket immediately after /quit, so this is for info only
        }
        else if (msg.startsWith("ERROR:")) {
          log("[ERROR] " + msg.slice(6),"err");
        }
        else {
          log("[Server] " + msg, "sys");
        }
      };
      ws.onclose = () => {
        info("Connection closed.");
        log("[Disconnected from server.]");
      };
      ws.onerror = (e) => {
        info("WebSocket error!");
        log("[WebSocket error: check console for details.]", "err");
      };
    }

    connect();

    document.getElementById('sendBtn').onclick = send;
    document.getElementById('userInput').onkeydown = (e) => {
      if (e.key === "Enter") send();
    };

    function send() {
      const inp = document.getElementById('userInput');
      let txt = inp.value.trim();
      if (!txt) return;
      if (!ws || ws.readyState !== 1) {
        log("[Cannot send: not connected.]","err");
        return;
      }
      if (txt === "/quit") {
        quitting = true;
        ws.send("LEAVE");
        info("Leaving chat...");
        ws.close();   // Close immediately after /quit command
      } else if (txt.startsWith("/join ")) {
        ws.send("JOIN:" + txt.split(" ",2)[1]);
      } else if (txt.startsWith("/name ")) {
        // Update our name locally!
        myName = txt.slice(6).trim();
        updateInfo();
        log(`[You are now known as: ${myName}]`, "sys");
        ws.send("RENAME:" + myName);
      } else if (txt === "/chatroom") {
        ws.send("/chatroom");
      } else if (txt === "/list") {
        ws.send("/list");
      } else {
        ws.send("MSG:" + txt);
        log(`You: ${txt}`, "me");
      }                                                                                                                       inp.value = "";
    }

  </script>
</body>
</html>
